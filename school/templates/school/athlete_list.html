{% extends 'school/base.html' %}

{% block title %}Спортсмены{% endblock %}

{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2>Спортсмены</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a class="btn btn-outline-primary" href="#">Добавить</a>
    </div>
</div>

<div class="row">
    <div class="col-3">

        <div class="table-responsive small">
            <table class="table table-striped table-sm">
                <thead>
                <tr>
                    <th scope="col">№</th>
                    <th scope="col">Фамилия, Имя</th>
                    <th scope="col">Группа</th>
                </tr>
                </thead>
                <tbody>
                {% for athlete in object_list %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <a href="#" class="edit-athlete" data-athlete-id="{{ athlete.id }}" title="Изменить">
                                <svg class="bi text-primary">
                                    <use xlink:href="/static/svg/icons-button.svg#person-gear"/>
                                </svg>
                            </a>
                        <a title="Исключить" href="#">
                            <svg class="bi text-danger">
                                <use xlink:href="/static/svg/icons-button.svg#person-x"/>
                            </svg>
                        </a> {{ athlete.person.surname }} {{ athlete.person.name }}
                    </td>
                    <td>
                        {% for group in athlete.groups_athletes.all %}
                        {{ group.name }}
                        {% endfor %}
                    </td>
                    <td>{{ athlete.person.birth_date }}</td>

                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    <!-- Правая часть экрана для формы редактирования -->
    <div class="col-9" id="athlete-form-container">
        <!-- Форма редактирования будет загружаться сюда через AJAX -->
    </div>
</div>

<script>
    document.querySelectorAll('.edit-athlete').forEach(function(button) {
    button.addEventListener('click', function(event) {
        event.preventDefault();
        let athleteId = button.getAttribute('data-athlete-id');

        // Загружаем форму редактирования спортсмена
        fetch(`/athlete/${athleteId}/edit/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('athlete-form-container').innerHTML = html;

                // Обрабатываем отправку формы
                const form = document.getElementById('athlete-edit-form');
                form.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const formData = new FormData(form);
                    // Добавление CSRF токена
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                    fetch(`/athlete/${athleteId}/edit/`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.text())
                    .then(html => {
                        // Обновить форму или выполнить другие действия после успешного сохранения
                        document.getElementById('athlete-form-container').innerHTML = html;
                    })
                    .catch(error => console.error('Ошибка при отправке формы:', error));
                });
            })
            .catch(error => console.error('Ошибка при загрузке формы:', error));
    });
});
</script>

{% endblock %}

